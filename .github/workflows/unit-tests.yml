name: Unit Tests

on:
  push:
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
    
    - name: Install uv
      uses: astral-sh/setup-uv@v2
      with:
        version: "latest"
    
    - name: Set up Python
      run: uv python install 3.12
    
    - name: Install PlatformIO with uv
      run: uv tool install platformio
    
    - name: Run unit tests
      run: |
        cd /home/runner/work/ESPTimeCast/ESPTimeCast
        pio test -e native
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v6
      with:
        name: test-results
        path: .pio/build/native/

  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
    
    - name: Install uv
      uses: astral-sh/setup-uv@v2
      with:
        version: "latest"
    
    - name: Set up Python
      run: uv python install 3.12
    
    - name: Install PlatformIO with uv
      run: uv sync
    
    - name: Build ESP32-C3
      run: |
        cd /home/runner/work/ESPTimeCast/ESPTimeCast
        uv run pio run -e esp32_c3
    
    - name: Build ESP32-S3
      run: |
        cd /home/runner/work/ESPTimeCast/ESPTimeCast
        uv run pio run -e esp32_s3
    
    - name: Upload build artifacts
      if: always()
      uses: actions/upload-artifact@v6
      with:
        name: firmware-binaries
        path: |
          .pio/build/esp32_c3/firmware.bin
          .pio/build/esp32_s3/firmware.bin
