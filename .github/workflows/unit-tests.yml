name: Unit Tests

on:
  push:

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
    
    - name: Install uv
      uses: astral-sh/setup-uv@v2
      with:
        version: "latest"
    
    - name: Set up Python
      run: uv python install 3.12
    
    - name: Install PlatformIO with uv
      run: uv tool install platformio
    
    - name: Run unit tests
      run: |
        cd /home/runner/work/ESPTimeCast/ESPTimeCast
        pio test -e native
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v6
      with:
        name: test-results
        path: .pio/build/native/

  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        variant: [esp32_c3, esp32_s2]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
    
    - name: Install uv
      uses: astral-sh/setup-uv@v2
      with:
        version: "latest"
    
    - name: Set up Python
      run: uv python install 3.12
    
    - name: Install PlatformIO with uv
      run: uv tool install platformio
    
    - name: Build ${{ matrix.variant }}
      run: |
        cd /home/runner/work/ESPTimeCast/ESPTimeCast
        pio run -e ${{ matrix.variant }}
    
    - name: Upload build artifacts
      if: always()
      uses: actions/upload-artifact@v6
      with:
        name: firmware-${{ matrix.variant }}
        path: .pio/build/${{ matrix.variant }}/firmware.bin
